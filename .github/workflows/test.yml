name: test

on:
  workflow_dispatch:
  pull_request: ~
  push:
    branches:
      - master

jobs:
  test_linux:
    name: "linux test: ${{ matrix.arch }}"
    runs-on: ubuntu-20.04 # use older version on purpose for GLIBC
    strategy:
      fail-fast: true
      matrix:
        # arch: [x86_64, aarch64, armv7]
        arch: [aarch64]
        sys: [linux]
        include:
          - arch: x86_64
            ccarch: x86_64
            archproc: x86_64
          - arch: aarch64
            ccarch: aarch64
            archproc: aarch64
          - arch: armv7
            ccarch: arm
            archproc: armv7l
    steps:
      - uses: actions/checkout@v3
      - name: build-deps
        run: |
          sudo apt-get update
          sudo apt-get install g++-12-${{ matrix.ccarch }}-linux-gnu
      - name: configure
        run: |
          export CC="${{ matrix.ccarch }}-${{ matrix.sys }}-gcc-12"
          export CXX="${{ matrix.ccarch }}-${{ matrix.sys }}-g++-12"
          cmake -Bbuild -DCMAKE_INSTALL_PREFIX=_install/piper-phonemize -DCMAKE_SYSTEM_PROCESSOR=${{ matrix.archproc }}
      - name: build
        run: |
          cmake --build build --config Release
      - name: install
        run: |
          cmake --install build
      - name: test
        run: |
          LD_LIBRARY_PATH=$PWD/_install/piper-phonemize/lib _install/piper-phonemize/bin/piper_phonemize --help
  # test_windows:
  #   runs-on: windows-latest
  #   name: "windows build: ${{ matrix.arch }}"
  #   strategy:
  #     fail-fast: true
  #     matrix:
  #       arch: [x64]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - name: configure
  #       run: |
  #         cmake -Bbuild -DCMAKE_INSTALL_PREFIX=_install/piper-phonemize
  #     - name: build
  #       run: |
  #         cmake --build build --config Release
  #     - name: install
  #       run: |
  #         cmake --install build
  #     - name: check
  #       run: |
  #         _install/piper-phonemize/bin/piper_phonemize_exe --help
  # test_mac:
  #   name: "mac test: ${{ matrix.arch }}"
  #   runs-on: macos-latest
  #   strategy:
  #     fail-fast: true
  #     matrix:
  #       arch: [x64, aarch64]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - name: configure
  #       run: |
  #         cmake -Bbuild -DCMAKE_INSTALL_PREFIX=_install/piper-phonemize
  #     - name: build
  #       run: |
  #         cmake --build build --config Release
  #     - name: install
  #       run: |
  #         cmake --install build
  #     - name: test
  #       run: |
  #         DYLD_LIBRARY_PATH=$PWD/_install/piper-phonemize/lib _install/piper-phonemize/bin/piper_phonemize --help
